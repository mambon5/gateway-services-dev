<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>global_vars &mdash; Gateway communication&#39;s code 01-05-2023 documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/graphviz.css" type="text/css" />
      <link rel="stylesheet" href="../_static/style.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../index.html" class="icon icon-home"> Gateway communication's code
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../modules/backend_script_cloud_comms.html">backend_script_cloud_comms</a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/backend_script_node_comms.html">backend_script_node_comms</a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/cloud_settings.html">cloud_settings</a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/compute_crc.html">compute_crc</a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/create_message_cloud.html">create_message_cloud</a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/create_message_functions.html">create_message_functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/create_message_nodes.html">create_message_nodes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/create_message_specific_functions.html">create_message_specific_functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/database_functions.html">database_functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/global_vars.html">global_vars</a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/interaction_tunnel.html">interaction_tunnel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/local_settings.html">local_settings</a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/message_display_functions.html">message_display_functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/message_display_specific_functions.html">message_display_specific_functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/message_received_class.html">message_received_class</a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/message_received_parse_functions.html">message_received_parse_functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/message_specific_parse_functions.html">message_specific_parse_functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/mqtt_credentials.html">mqtt_credentials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/mqtt_interaction_cloud.html">mqtt_interaction_cloud</a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/mqtt_interaction_module.html">mqtt_interaction_module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/mqtt_interaction_node_basic.html">mqtt_interaction_node_basic</a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/mqtt_interaction_node_main.html">mqtt_interaction_node_main</a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/mqtt_interaction_node_temporal.html">mqtt_interaction_node_temporal</a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/otap_menu.html">otap_menu</a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/otap_specific_functions.html">otap_specific_functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/otap_update_all_nodes.html">otap_update_all_nodes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/prepare_response.html">prepare_response</a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/read_gw_database.html">read_gw_database</a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/start_gw_comms.html">start_gw_comms</a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/update_gw_database.html">update_gw_database</a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/update_gw_software.html">update_gw_software</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Gateway communication's code</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">Module code</a></li>
      <li class="breadcrumb-item active">global_vars</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for global_vars</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Most used variables and functions throughout all the gateway&#39;s code. Any script uses or can use them. </span>
<span class="sd">These simple functions included here include those that:</span>

<span class="sd">- unpack messages to bytes *(the packing to bytes is done in the send_message_function)*</span>
<span class="sd">- compute the CRC of a message</span>
<span class="sd">- extract a supertopic </span>
<span class="sd">- create the Wirepas Network Interface</span>
<span class="sd">- create the OtapHelper</span>
<span class="sd">- get sink and gateway ids</span>
<span class="sd">- select element from the list</span>
<span class="sd">- and more</span>

<span class="sd">these functions are indiscriminately used </span>
<span class="sd">in many classes, functions and files throughout the gateway backend app.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">pathlib</span>
<span class="kn">from</span> <span class="nn">struct</span> <span class="kn">import</span> <span class="o">*</span> <span class="c1">#: for pack and unpacking functions</span>
<span class="kn">import</span> <span class="nn">datetime</span>                 <span class="c1">#: to create timestamp for sent and received messages</span>
<span class="kn">import</span> <span class="nn">mqtt_credentials</span> <span class="k">as</span> <span class="nn">creds</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">wirepas_mqtt_library</span> <span class="kn">import</span> <span class="n">WirepasNetworkInterface</span><span class="p">,</span> <span class="n">WirepasOtapHelper</span>
<span class="k">except</span> <span class="ne">ModuleNotFoundError</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Please install Wirepas mqtt library wheel: pip install wirepas-mqtt-library==1.0&quot;</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

<span class="c1">#: Gateway&#39;s sink default network channel. This will be the default network channel to be used by the sinks of the gateway we put</span>
<span class="c1">#: this number is very improtant because in order to activate all the sinks of a gateway, we must specify the network channel first</span>
<span class="c1">#: the python scripts that activate automatically the sinks, use this value to detect the sinks connected to the network that we </span>
<span class="c1">#: want to activate. So far, we decided to use network channel 5</span>
<span class="n">NETWORK_DEFAULT_CHANNEL</span> <span class="o">=</span> <span class="mi">5</span>

<span class="c1">#: Message ID of Gateway Backend to Node communications:</span>
<span class="n">MSG_TYPE_ERROR</span> <span class="o">=</span> <span class="mi">0</span>

<span class="c1">#: VERSION OF THE GATEWAY SOFTWARE WITH FORMAT &quot;MAJOR.MINOR.REVISION.BUILDNUMBER&quot;</span>
<span class="c1">#: MAJOR is a major release (usually many new features or changes to the UI or underlying OS)</span>
<span class="c1">#: MINOR is a minor release (perhaps some new features) on a previous major release</span>
<span class="c1">#: REVISION is usually a fix for a previous minor release (no new functionality)</span>
<span class="c1">#: BUILDNUMBER is incremented for each latest build of a revision.</span>
<span class="n">GATEWAY_VERSION</span><span class="o">=</span><span class="s2">&quot;0.2.2.1&quot;</span>
<span class="c1"># major_release.minor_release.revision_fixes.build_number</span>

<span class="c1">#: GATEWAY TO NODE REQUESTS</span>
<span class="c1">#: &quot;Set led On&quot; message type.</span>
<span class="n">MSG_TYPE_GW_SET_LED_ON</span> <span class="o">=</span> <span class="mi">1</span>
<span class="c1">#: &quot;Set led Off&quot; message</span>
<span class="n">MSG_TYPE_GW_SET_LED_OFF</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">MSG_TYPE_GW_SET_DIMMING</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">MSG_TYPE_GW_SET_BLINKING</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">MSG_TYPE_GW_SET_STRATEGY</span> <span class="o">=</span> <span class="mi">5</span>

<span class="c1">#: Get information messages from Gateway to node:</span>
<span class="c1">#: &quot;send echo command&quot; message type.</span>
<span class="n">MSG_TYPE_GW_ECHO</span> <span class="o">=</span> <span class="mi">6</span>
<span class="c1">#: get led status</span>
<span class="n">MSG_TYPE_GW_GET_LED_STATUS</span> <span class="o">=</span> <span class="mi">7</span>
<span class="c1">#: get dimming status</span>
<span class="n">MSG_TYPE_GW_GET_DIMMING_STATUS</span> <span class="o">=</span> <span class="mi">8</span>
<span class="c1">#: get number of neighbours</span>
<span class="n">MSG_TYPE_GW_GET_NUMBER_OF_NEIGHBOURS</span> <span class="o">=</span> <span class="mi">9</span>
<span class="c1">#: get rssi node signal strength</span>
<span class="n">MSG_TYPE_GW_GET_RSSI</span> <span class="o">=</span> <span class="mi">10</span>
<span class="c1">#: get number of jumpts of the node until it reaches the sink</span>
<span class="n">MSG_TYPE_GW_GET_HOPS</span> <span class="o">=</span> <span class="mi">11</span>
<span class="c1">#: get node status</span>
<span class="n">MSG_TYPE_GW_GET_NODE_STATUS</span> <span class="o">=</span> <span class="mi">12</span>
<span class="c1">#: get new strategy</span>
<span class="n">MSG_TYPE_GW_SEND_NEW_STRAGEGY</span> <span class="o">=</span> <span class="mi">13</span>


<span class="c1">#:list of different responses recieved by gw from node:</span>
<span class="n">MSG_RESPONSE_RECEIVED_FROM_NODES_LIST</span> <span class="o">=</span> <span class="p">[</span>
<span class="n">MSG_TYPE_ERROR</span><span class="p">,</span>
<span class="n">MSG_TYPE_GW_SET_LED_ON</span> <span class="p">,</span>
<span class="n">MSG_TYPE_GW_SET_LED_OFF</span><span class="p">,</span>
<span class="n">MSG_TYPE_GW_SET_DIMMING</span><span class="p">,</span>
<span class="n">MSG_TYPE_GW_SET_BLINKING</span><span class="p">,</span>
<span class="n">MSG_TYPE_GW_SET_STRATEGY</span><span class="p">,</span>
<span class="n">MSG_TYPE_GW_ECHO</span><span class="p">,</span>
<span class="n">MSG_TYPE_GW_GET_LED_STATUS</span><span class="p">,</span>
<span class="n">MSG_TYPE_GW_GET_DIMMING_STATUS</span><span class="p">,</span>
<span class="n">MSG_TYPE_GW_GET_NUMBER_OF_NEIGHBOURS</span><span class="p">,</span>
<span class="n">MSG_TYPE_GW_GET_RSSI</span><span class="p">,</span>
<span class="n">MSG_TYPE_GW_GET_NODE_STATUS</span><span class="p">,</span>
<span class="n">MSG_TYPE_GW_SEND_NEW_STRAGEGY</span>
<span class="p">]</span>


<span class="c1">#: do we want to use this message id? the wirepas guys defined it in the original app?:</span>
<span class="c1">#: Unknown or unsupported message ID value.</span>
<span class="n">MSG_TYPE_INVALID_UNSUPPORTED_MSG</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>


<span class="c1">#: NODE to GATEWAY REQUESTS</span>
<span class="c1">#: &quot;get time from connected gateway&quot; message ID.</span>
<span class="n">MSG_TYPE_NODE_GET_TIME</span> <span class="o">=</span> <span class="mi">201</span>
<span class="c1">#: send alarm</span>
<span class="n">MSG_TYPE_NODE_SEND_ALARM</span> <span class="o">=</span> <span class="mi">202</span>
<span class="c1">#: send current node voltage to gateway</span>
<span class="n">MSG_TYPE_NODE_SEND_CURRENT_VOLTAGE</span> <span class="o">=</span> <span class="mi">203</span>
<span class="c1">#: send current node electric parameters to gateway</span>
<span class="n">MSG_TYPE_NODE_SEND_ELECTRIC_PARAMETERS</span> <span class="o">=</span> <span class="mi">204</span>
<span class="c1">#: send current node solar panel metrics to gateway</span>
<span class="n">MSG_TYPE_NODE_SEND_SOLAR_PANEL_METRICS</span> <span class="o">=</span> <span class="mi">205</span>
<span class="c1">#: send node status to gateway</span>
<span class="n">MSG_TYPE_NODE_SEND_NODE_STATUS</span> <span class="o">=</span> <span class="mi">206</span>


<span class="c1">#: list of node started messages or requeststs</span>
<span class="n">MSG_NODE_REQUESTS_LIST</span> <span class="o">=</span> <span class="p">[</span>
<span class="n">MSG_TYPE_NODE_GET_TIME</span><span class="p">,</span>
<span class="n">MSG_TYPE_NODE_SEND_ALARM</span><span class="p">,</span>
<span class="n">MSG_TYPE_NODE_SEND_CURRENT_VOLTAGE</span><span class="p">,</span>
<span class="n">MSG_TYPE_NODE_SEND_ELECTRIC_PARAMETERS</span><span class="p">,</span>
<span class="n">MSG_TYPE_NODE_SEND_SOLAR_PANEL_METRICS</span><span class="p">,</span>
<span class="n">MSG_TYPE_NODE_SEND_NODE_STATUS</span>
<span class="p">]</span>


<span class="c1"># CLOUD to NODE REQUESTS</span>
<span class="c1">#commands</span>
<span class="c1">#: cloud sends SET LED ON command to node</span>
<span class="n">MSG_TYPE_CLOUD_TO_NODE_SET_LED_ON</span> <span class="o">=</span> <span class="mi">1</span>
<span class="c1">#: cloud sends SET LED OFF command to node</span>
<span class="n">MSG_TYPE_CLOUD_TO_NODE_SET_LED_OFF</span> <span class="o">=</span> <span class="mi">2</span>
<span class="c1">#: cloud sends SET DIMMING command to node</span>
<span class="n">MSG_TYPE_CLOUD_TO_NODE_SET_DIMMING</span> <span class="o">=</span> <span class="mi">3</span>
<span class="c1">#: cloud sends SET BLINKING command to node</span>
<span class="n">MSG_TYPE_CLOUD_TO_NODE_SET_BLINKING</span> <span class="o">=</span> <span class="mi">4</span>
<span class="c1">#: cloud sends SET STRATEGY command to node</span>
<span class="n">MSG_TYPE_CLOUD_TO_NODE_SET_STRATEGY</span> <span class="o">=</span> <span class="mi">5</span>

<span class="c1"># info messages</span>
<span class="c1">#: cloud sends GET TRAVELTIME command to node</span>
<span class="n">MSG_TYPE_CLOUD_TO_NODE_ECHO</span> <span class="o">=</span> <span class="mi">6</span>
<span class="c1">#: cloud sends GET LED STATUS command to node</span>
<span class="n">MSG_TYPE_CLOUD_TO_NODE_GET_LED_STATUS</span> <span class="o">=</span> <span class="mi">7</span>
<span class="c1">#: cloud sends GET DIMMING STATUS command to node</span>
<span class="n">MSG_TYPE_CLOUD_TO_NODE_GET_DIMMING_STATUS</span> <span class="o">=</span> <span class="mi">8</span>
<span class="c1">#: cloud sends GET NUMBER OF NEIGHBOURS command to node</span>
<span class="n">MSG_TYPE_CLOUD_TO_NODE_GET_NUMBER_OF_NEIGHBOURS</span> <span class="o">=</span> <span class="mi">9</span>
<span class="c1">#: cloud sends GET RSSI command to node</span>
<span class="n">MSG_TYPE_CLOUD_TO_NODE_GET_RSSI</span> <span class="o">=</span> <span class="mi">10</span>
<span class="c1">#: cloud sends GET NUMBER OF HOPS command to node</span>
<span class="n">MSG_TYPE_CLOUD_TO_NODE_GET_HOPS</span> <span class="o">=</span> <span class="mi">11</span>
<span class="c1">#: cloud sends GET ALL NODE STATUS VALUES command to node</span>
<span class="n">MSG_TYPE_CLOUD_TO_NODE_GET_NODE_STATUS</span> <span class="o">=</span> <span class="mi">12</span>
<span class="c1">#: cloud sends GET USED STRATEGY NUMBER command to node</span>
<span class="n">MSG_TYPE_CLOUD_TO_NODE_SEND_NEW_STRAGEGY</span> <span class="o">=</span> <span class="mi">13</span>
<span class="c1">#: cloud sends GET NODE VERSION command to node</span>
<span class="n">MSG_TYPE_CLOUD_TO_NODE_GET_VERSION</span> <span class="o">=</span> <span class="mi">14</span>

<span class="c1">#: LIST OF valid message types</span>
<span class="n">MSG_CLOUD_TO_NODE_REQUESTS_LIST</span> <span class="o">=</span> <span class="p">[</span>
<span class="n">MSG_TYPE_CLOUD_TO_NODE_SET_LED_ON</span><span class="p">,</span>
<span class="n">MSG_TYPE_CLOUD_TO_NODE_SET_LED_OFF</span><span class="p">,</span>
<span class="n">MSG_TYPE_CLOUD_TO_NODE_SET_DIMMING</span><span class="p">,</span>
<span class="n">MSG_TYPE_CLOUD_TO_NODE_SET_BLINKING</span><span class="p">,</span>
<span class="n">MSG_TYPE_CLOUD_TO_NODE_SET_STRATEGY</span><span class="p">,</span>
<span class="n">MSG_TYPE_CLOUD_TO_NODE_ECHO</span> <span class="p">,</span>
<span class="n">MSG_TYPE_CLOUD_TO_NODE_GET_LED_STATUS</span><span class="p">,</span>
<span class="n">MSG_TYPE_CLOUD_TO_NODE_GET_DIMMING_STATUS</span><span class="p">,</span>
<span class="n">MSG_TYPE_CLOUD_TO_NODE_GET_NUMBER_OF_NEIGHBOURS</span> <span class="p">,</span>
<span class="n">MSG_TYPE_CLOUD_TO_NODE_GET_RSSI</span><span class="p">,</span>
<span class="n">MSG_TYPE_CLOUD_TO_NODE_GET_HOPS</span><span class="p">,</span>
<span class="n">MSG_TYPE_CLOUD_TO_NODE_GET_NODE_STATUS</span><span class="p">,</span>
<span class="n">MSG_TYPE_CLOUD_TO_NODE_SEND_NEW_STRAGEGY</span><span class="p">,</span>
<span class="n">MSG_TYPE_CLOUD_TO_NODE_GET_VERSION</span>
<span class="p">]</span>

<span class="c1"># CLOUD to GATEWAY REQUESTS</span>
<span class="c1"># commands</span>
<span class="c1">#: cloud sends SET ALL LEDS ON command to gateway (COMMAND not used anymore)</span>
<span class="c1"># MSG_TYPE_CLOUD_TO_GATEWAY_ALL_LED_ON = 1        # &lt;-- we decided not to use this message type</span>
<span class="c1"># MSG_TYPE_CLOUD_TO_GATEWAY_ALL_LED_OFF = 2       # &lt;-- we decided not to use this message type</span>
<span class="c1"># MSG_TYPE_CLOUD_TO_GATEWAY_ALL_DIMMING = 3       # &lt;-- we decided not to use this message type</span>
<span class="c1"># get info</span>
<span class="c1">#: send request to get the node list</span>
<span class="n">MSG_TYPE_CLOUD_TO_GATEWAY_NODE_LIST</span> <span class="o">=</span> <span class="mi">4</span>
<span class="c1">#: send request to get the node status</span>
<span class="c1"># MSG_TYPE_CLOUD_TO_GATEWAY_NODE_STATUS = 5       # &lt;-- we decided not to use this message type</span>
<span class="c1">#: tell gateway to remove nodes</span>
<span class="n">MSG_TYPE_CLOUD_TO_GATEWAY_REMOVE_NODES</span> <span class="o">=</span> <span class="mi">6</span>
<span class="c1">#: tell gateway to update its software</span>
<span class="n">MSG_TYPE_CLOUD_TO_GATEWAY_UPDATE_GATEWAY</span> <span class="o">=</span> <span class="mi">7</span>
<span class="c1">#: tell gateway to update its nodes using OTAP</span>
<span class="n">MSG_TYPE_CLOUD_TO_GATEWAY_UPDATE_NODES</span> <span class="o">=</span> <span class="mi">8</span>
<span class="c1">#: ask gateway its software version</span>
<span class="n">MSG_TYPE_CLOUD_TO_GATEWAY_GET_GATEWAY_VERSION</span> <span class="o">=</span> <span class="mi">9</span>


<span class="c1">#: list of valid messages from cloud to gateway</span>
<span class="n">MSG_CLOUD_TO_GATEWAY_REQUESTS_LIST</span> <span class="o">=</span> <span class="p">[</span>
<span class="c1"># MSG_TYPE_CLOUD_TO_GATEWAY_ALL_LED_ON,       # &lt;-- we decided not to use this message type</span>
<span class="c1"># MSG_TYPE_CLOUD_TO_GATEWAY_ALL_LED_OFF,       # &lt;-- we decided not to use this message type</span>
<span class="c1"># MSG_TYPE_CLOUD_TO_GATEWAY_ALL_DIMMING,       # &lt;-- we decided not to use this message type</span>
<span class="c1">#: get info</span>
<span class="n">MSG_TYPE_CLOUD_TO_GATEWAY_NODE_LIST</span><span class="p">,</span>
<span class="c1"># MSG_TYPE_CLOUD_TO_GATEWAY_NODE_STATUS,       # &lt;-- we decided not to use this message type</span>
<span class="n">MSG_TYPE_CLOUD_TO_GATEWAY_REMOVE_NODES</span><span class="p">,</span>
<span class="n">MSG_TYPE_CLOUD_TO_GATEWAY_UPDATE_GATEWAY</span><span class="p">,</span>
<span class="n">MSG_TYPE_CLOUD_TO_GATEWAY_UPDATE_NODES</span><span class="p">,</span>
<span class="n">MSG_TYPE_CLOUD_TO_GATEWAY_GET_GATEWAY_VERSION</span> 
<span class="p">]</span>

<span class="c1"># GATEWAY TO CLOUD MESSAGE TYPES</span>
<span class="n">MSG_TYPE_ALIVE_GW_TO_CLOUD</span> <span class="o">=</span> <span class="mi">1</span>          <span class="c1">#: gw tells its id to cloud</span>
<span class="n">MSG_TYPE_ADD_NODES_GW_TO_CLOUD</span> <span class="o">=</span> <span class="mi">2</span>      <span class="c1">#: gw tells cloud to add some new nodes associated to this gateway</span>
<span class="n">MSG_TYPE_UNSEEN_NODES_GW_TO_CLOUD</span> <span class="o">=</span> <span class="mi">3</span>   <span class="c1">#: gw tells cloud there are some nodes it doesnt see anymore</span>
<span class="n">MSG_TYPE_NODE_STATUS_GW_TO_CLOUD</span> <span class="o">=</span> <span class="mi">4</span>    <span class="c1">#: gw tells cloud the node status of its nodes</span>
<span class="n">MSG_TYPE_ALARM_GW_TO_CLOUD</span> <span class="o">=</span> <span class="mi">5</span>          <span class="c1">#: gw sends an alarm to the cloud</span>
<span class="n">MSG_TYPE_ELECTRIC_PARAMETERS_GW_TO_CLOUD</span> <span class="o">=</span> <span class="mi">6</span>    <span class="c1">#: gw tells cloud the electrical parameters of its associated nodes</span>

<span class="c1">#: gateway to cloud list of valid message types</span>
<span class="n">MSG_GATEWAY_TO_CLOUD_LIST</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">MSG_TYPE_ALIVE_GW_TO_CLOUD</span><span class="p">,</span>
    <span class="n">MSG_TYPE_ADD_NODES_GW_TO_CLOUD</span><span class="p">,</span>
    <span class="n">MSG_TYPE_UNSEEN_NODES_GW_TO_CLOUD</span><span class="p">,</span>
    <span class="n">MSG_TYPE_NODE_STATUS_GW_TO_CLOUD</span><span class="p">,</span>
    <span class="n">MSG_TYPE_ALARM_GW_TO_CLOUD</span><span class="p">,</span>
    <span class="n">MSG_TYPE_ELECTRIC_PARAMETERS_GW_TO_CLOUD</span>
<span class="p">]</span>

<span class="c1">#expected message lengths:</span>
<span class="c1">#: error msg expected length:</span>
<span class="n">EXPECTED_LENGTH_ERROR</span> <span class="o">=</span> <span class="mi">4</span>

<span class="c1">#: EXPECTED LENGTH NODE RESPONSE TO GATEWAY</span>
<span class="c1">#: NODE RESONSE TO GATEWAY</span>
<span class="n">EXPECTED_LENGTH_NO_ARGUMENTS</span> <span class="o">=</span> <span class="mi">3</span>
<span class="c1">#: &quot;SET DIMMING REPONSE&quot; expected byte length.</span>
<span class="n">EXPECTED_LENGTH_SET_DIMMING_RESPONSE_MSG</span> <span class="o">=</span> <span class="mi">4</span>
<span class="c1">#: &quot;SET STRATEGY REPONSE&quot; expected byte length.</span>
<span class="n">EXPECTED_LENGTH_SET_STRATEGY_RESPONSE_MSG</span> <span class="o">=</span> <span class="mi">4</span>
<span class="c1">#: &quot;SET STRATEGY REPONSE&quot; expected byte length.</span>
<span class="n">EXPECTED_LENGTH_SEND_ECHO_RESPONSE_MSG_FROM_NODE</span> <span class="o">=</span> <span class="mi">7</span>
<span class="c1">#: &quot;get led status REPONSE&quot; expected byte length.</span>
<span class="n">EXPECTED_LENGTH_GET_LED_STATUS_RESPONSE_MSG</span> <span class="o">=</span> <span class="mi">4</span>
<span class="c1">#: &quot;get dimming status REPONSE&quot; expected byte length.</span>
<span class="n">EXPECTED_LENGTH_GET_DIMMING_STATUS_RESPONSE_MSG</span> <span class="o">=</span> <span class="mi">4</span>
<span class="c1">#: &quot;get number of neighbours REPONSE&quot; expected byte length.</span>
<span class="n">EXPECTED_LENGTH_GET_NUMBER_OF_NEIGHBOURS_RESPONSE_MSG</span> <span class="o">=</span> <span class="mi">7</span>
<span class="c1">#: &quot;get rssi REPONSE&quot; expected byte length.</span>
<span class="n">EXPECTED_LENGTH_GET_RSSI_RESPONSE_MSG</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">EXPECTED_LENGTH_GET_HOPS_RESPONSE_MSG</span> <span class="o">=</span> <span class="mi">4</span>
<span class="c1">#: &quot;get NODE status REPONSE&quot; expected byte length for mesh network</span>
<span class="n">EXPECTED_LENGTH_GET_NODE_STATUS_RESPONSE_MSG_MESH_NETWORK</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">EXPECTED_LENGTH_GET_NEW_STRATEGY_RESPONSE_MSG_MESH_NETWORK</span> <span class="o">=</span> <span class="mi">35</span>

<span class="c1"># expected length for NODE REQUESTS TO GATEWAY:</span>
<span class="n">EXPECTED_LENGTH_NODE_TO_GATEWAY_GET_TIME_REQUEST</span> <span class="o">=</span> <span class="mi">3</span>                <span class="c1">#: expected message length for node GET TIME request to gateway</span>
<span class="n">EXPECTED_LENGTH_NODE_TO_GATEWAY_ALARM_REQUEST</span> <span class="o">=</span> <span class="mi">4</span>                   <span class="c1">#: expected message length for node send ALARM to gateway</span>
<span class="n">EXPECTED_LENGTH_NODE_TO_GATEWAY_CURRENT_VOLTAGE_REQUEST</span> <span class="o">=</span> <span class="mi">8</span>         <span class="c1">#: expected message length for node send CURRENT &amp; VOLTAGE to gateway</span>
<span class="n">EXPECTED_LENGTH_NODE_TO_GATEWAY_ELECTRIC_PARAMETERS_REQUEST</span> <span class="o">=</span> <span class="mi">15</span>    <span class="c1">#: expected message length for node send ELECTRIC PARAMETERS to gateway</span>
<span class="n">EXPECTED_LENGTH_NODE_TO_GATEWAY_SOLAR_METRICS_REQUEST</span> <span class="o">=</span> <span class="mi">7</span>           <span class="c1">#: expected message length for node send SOLAR METRICS to gateway</span>
<span class="n">EXPECTED_LENGTH_NODE_TO_NODE_STATUS_REQUEST</span> <span class="o">=</span> <span class="mi">10</span>                    <span class="c1">#: expected message length for node send ALL NODE STATUS VALUES to gateway</span>

<span class="c1"># EXPECTED MSG LENGTH CLOUD REQ TO NODE</span>
<span class="n">EXPECTED_LENGTH_SET_DIMMING_REQUEST_MSG</span> <span class="o">=</span> <span class="n">EXPECTED_LENGTH_SET_DIMMING_RESPONSE_MSG</span>
<span class="n">EXPECTED_LENGTH_SET_STRATEGY_REQUEST_MSG</span> <span class="o">=</span> <span class="n">EXPECTED_LENGTH_SET_STRATEGY_RESPONSE_MSG</span>
<span class="n">EXPECTED_LENGTH_CLOUD_TO_NODE_GET_VERSION_REQUEST</span> <span class="o">=</span> <span class="mi">3</span>


<span class="c1"># EXPECTED MSG LENGTH CLOUD REQ TO GATEWAY</span>
<span class="n">EXPECTED_LENGTH_ALL_LED_ON_CLOUD_TO_GATEWAY_REQUEST</span> <span class="o">=</span> <span class="mi">7</span>
<span class="n">EXPECTED_LENGTH_ALL_LED_OFF_CLOUD_TO_GATEWAY_REQUEST</span> <span class="o">=</span> <span class="mi">7</span>
<span class="n">EXPECTED_LENGTH_ALL_DIMMING_CLOUD_TO_GATEWAY_REQUEST</span> <span class="o">=</span> <span class="mi">8</span>
<span class="n">EXPECTED_LENGTH_NODE_LIST_CLOUD_TO_GATEWAY_REQUEST</span> <span class="o">=</span> <span class="mi">7</span>
<span class="n">EXPECTED_LENGTH_NODE_STATUS_CLOUD_TO_GATEWAY_REQUEST</span> <span class="o">=</span> <span class="mi">7</span>
<span class="n">EXPECTED_LENGTH_UPDATE_GW_SOFTWARE_CLOUD_TO_GATEWAY_REQUEST</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">EXPECTED_LENGTH_UPDATE_NODES_SOFTWARE_CLOUD_TO_GATEWAY_REQUEST</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">EXPECTED_LENGTH_GET_GW_VERSION_CLOUD_TO_GATEWAY_REQUEST</span> <span class="o">=</span> <span class="mi">3</span>

<span class="c1">#: CLOUD RESPONSE TO GATEWAY REQUEST</span>
<span class="c1">#: &quot;get dimming status REPONSE&quot; expected byte length.</span>
<span class="n">EXPECTED_LENGTH_CLOUD_RESPONSE_TO_GATEWAY_ADD_NODES_REQUEST_MSG</span> <span class="o">=</span> <span class="mi">7</span>
<span class="c1">#: &quot;get number of neighbours REPONSE&quot; expected byte length.</span>
<span class="n">EXPECTED_LENGTH_CLOUD_RESPONSE_TO_GATEWAY_REMOVE_NODES_REQUEST_MSG</span> <span class="o">=</span> <span class="mi">7</span>
<span class="c1">#: &quot;get rssi REPONSE&quot; expected byte length.</span>
<span class="n">EXPECTED_LENGTH_CLOUD_RESPONSE_TO_GATEWAY_NODE_STATUS_REQUEST_MSG</span> <span class="o">=</span> <span class="mi">7</span>
<span class="c1">#: &quot;get number of hops REPONSE&quot; expected byte length.</span>
<span class="n">EXPECTED_LENGTH_CLOUD_RESPONSE_TO_GATEWAY_ALARM_REQUEST_MSG</span> <span class="o">=</span> <span class="mi">8</span>
<span class="c1">#: &quot;get NODE status REPONSE&quot; expected byte length.</span>
<span class="n">EXPECTED_LENGTH_CLOUD_RESPONSE_TO_GATEWAY_CONSUMS_REQUEST_MSG</span> <span class="o">=</span> <span class="mi">7</span>

<span class="c1">#: GATEWAY RESPONSE TO CLOUD TO NODE</span>
<span class="n">EXPECTED_LENGTH_GET_NODE_STATUS_RESPONSE_MSG_CLOUD</span> <span class="o">=</span> <span class="mi">11</span>
<span class="n">EXPECTED_LENGTH_GET_NODE_VERSION_RESPONSE_MSG_CLOUD</span> <span class="o">=</span> <span class="mi">11</span>
<span class="n">EXPECTED_LENGTH_GET_GATEWAY_VERSION_RESPONSE_MSG_CLOUD</span> <span class="o">=</span> <span class="mi">7</span>



<span class="c1"># Error types</span>
<span class="n">ERROR_TYPE_UNRESPONSIVE_DRIVER</span> <span class="o">=</span> <span class="mi">1</span>                  <span class="c1">#: unresponsive driver</span>
<span class="n">ERROR_TYPE_UNRESPONSIVE_NODE</span> <span class="o">=</span> <span class="mi">2</span>                    <span class="c1">#: unresponsive node</span>
<span class="n">ERROR_TYPE_NODE_ROM_FULL</span> <span class="o">=</span> <span class="mi">3</span>                        <span class="c1">#: node rom is full</span>
<span class="n">ERROR_TYPE_GATEWAY_ROM_FULL</span> <span class="o">=</span> <span class="mi">4</span>                     <span class="c1">#: gateway ROM is full</span>
<span class="n">ERROR_TYPE_GATEWAY_DATABASE_CONNECTION_ERROR</span> <span class="o">=</span> <span class="mi">5</span>    <span class="c1">#: database connection error</span>
<span class="n">ERROR_TYPE_UNEXPECTED_MESSAGE_LENGTH</span> <span class="o">=</span> <span class="mi">6</span>            <span class="c1">#: unexpected message length</span>
<span class="n">ERROR_TYPE_PARAMETERS_OUT_OF_RANGE</span> <span class="o">=</span> <span class="mi">7</span>              <span class="c1">#: parameters out of range</span>
<span class="n">ERROR_TYPE_NODE_NOT_IN_GATEWAY</span> <span class="o">=</span> <span class="mi">8</span>                  <span class="c1">#: node not in gateway node list</span>
<span class="n">ERROR_TYPE_INVALID_CRC</span> <span class="o">=</span> <span class="mi">9</span>                          <span class="c1">#: invalid CRC</span>
<span class="n">ERROR_TYPE_STRATEGY_NOT_FOUND</span> <span class="o">=</span> <span class="mi">10</span>                  <span class="c1">#: strategy not found</span>
<span class="n">ERROR_TYPE_WHEN_UPDATING_DATABASE</span> <span class="o">=</span> <span class="mi">11</span>              <span class="c1">#: error when updating database</span>
<span class="n">ERROR_TYPE_WHEN_READING_DATABASE</span> <span class="o">=</span> <span class="mi">12</span>               <span class="c1">#: error when reading database</span>
<span class="n">ERROR_TYPE_WHEN_UPDATING_GW_SOFTWARE</span> <span class="o">=</span> <span class="mi">13</span>           <span class="c1">#: while updating gateway software</span>
<span class="n">ERROR_TYPE_WHEN_TUNNELING_TO_NODE</span> <span class="o">=</span> <span class="mi">14</span>              <span class="c1">#: when tunneling to node</span>
<span class="n">ERROR_TYPE_INVALID_MSG_TYPE</span> <span class="o">=</span> <span class="mi">15</span>                    <span class="c1">#: invalid message type</span>
<span class="n">ERROR_TYPE_PAYLOAD_NOT_IN_BYTES</span> <span class="o">=</span> <span class="mi">16</span>                <span class="c1">#: payload not in bytes</span>
<span class="n">ERROR_TYPE_INVALID_MSG_ORIGIN_MQTT_TOPIC</span> <span class="o">=</span> <span class="mi">17</span>       <span class="c1">#: invalid mqtt topic</span>
<span class="n">ERROR_TYPE_OTAP_FAILED</span> <span class="o">=</span> <span class="mi">18</span>                         <span class="c1">#: OTAP failed</span>
<span class="n">ERROR_TYPE_WHEN_TUNNELING_TO_CLOUD</span> <span class="o">=</span> <span class="mi">19</span>             <span class="c1">#: when tunneling to the cloud</span>


<div class="viewcode-block" id="expected_length_node_list"><a class="viewcode-back" href="../modules/global_vars.html#global_vars.expected_length_node_list">[docs]</a><span class="k">def</span> <span class="nf">expected_length_node_list</span><span class="p">(</span><span class="n">num_nodes</span><span class="p">,</span> <span class="n">head_length</span><span class="o">=</span><span class="mi">9</span><span class="p">):</span> 
    <span class="sd">&quot;&quot;&quot;expected length for gateway response to cloud requests:&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">head_length</span> <span class="o">+</span> <span class="mi">8</span><span class="o">*</span><span class="n">num_nodes</span>   </div>


<div class="viewcode-block" id="expected_length_node_status_list"><a class="viewcode-back" href="../modules/global_vars.html#global_vars.expected_length_node_status_list">[docs]</a><span class="k">def</span> <span class="nf">expected_length_node_status_list</span><span class="p">(</span><span class="n">num_nodes</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;expected length node status list:&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="mi">5</span> <span class="o">+</span> <span class="mi">16</span><span class="o">*</span><span class="n">num_nodes</span></div>


<div class="viewcode-block" id="expected_length_alarm_node_list"><a class="viewcode-back" href="../modules/global_vars.html#global_vars.expected_length_alarm_node_list">[docs]</a><span class="k">def</span> <span class="nf">expected_length_alarm_node_list</span><span class="p">(</span><span class="n">num_nodes</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;alarm with nodes&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="mi">6</span> <span class="o">+</span> <span class="mi">8</span><span class="o">*</span><span class="n">num_nodes</span></div>


<div class="viewcode-block" id="expected_length_node_consum_list"><a class="viewcode-back" href="../modules/global_vars.html#global_vars.expected_length_node_consum_list">[docs]</a><span class="k">def</span> <span class="nf">expected_length_node_consum_list</span><span class="p">(</span><span class="n">num_nodes</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;expected length node consumption list:&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="mi">5</span> <span class="o">+</span> <span class="mi">20</span><span class="o">*</span><span class="n">num_nodes</span></div>

<div class="viewcode-block" id="expected_length_cloud_to_gw_remove_nodes"><a class="viewcode-back" href="../modules/global_vars.html#global_vars.expected_length_cloud_to_gw_remove_nodes">[docs]</a><span class="k">def</span> <span class="nf">expected_length_cloud_to_gw_remove_nodes</span><span class="p">(</span><span class="n">num_nodes</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;expected length remove nodes, cloud to gateway req&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="mi">5</span> <span class="o">+</span> <span class="mi">8</span><span class="o">*</span><span class="n">num_nodes</span></div>


<span class="c1">#: LED is switched OFF.</span>
<span class="n">LED_STATE_OFF</span> <span class="o">=</span> <span class="mi">0</span>
<span class="c1">#: LED is switched ON.</span>
<span class="n">LED_STATE_ON</span> <span class="o">=</span> <span class="mi">1</span>



<span class="c1">#: List of all supported message ID gateway &lt;&gt; node</span>
<span class="n">MSG_SUPPORTED_LIST_NODE</span> <span class="o">=</span> <span class="n">MSG_RESPONSE_RECEIVED_FROM_NODES_LIST</span> <span class="o">+</span> <span class="n">MSG_NODE_REQUESTS_LIST</span> <span class="o">+</span> <span class="n">MSG_GATEWAY_TO_CLOUD_LIST</span>
<span class="c1">#: List of all supported message ID gateway &lt;&gt; cloud</span>
<span class="n">MSG_SUPPORTED_LIST_CLOUD</span> <span class="o">=</span> <span class="n">MSG_CLOUD_TO_NODE_REQUESTS_LIST</span> <span class="o">+</span> <span class="n">MSG_CLOUD_TO_GATEWAY_REQUESTS_LIST</span> <span class="o">+</span> <span class="n">MSG_GATEWAY_TO_CLOUD_LIST</span>

<span class="sd">&quot;&quot;&quot; Application payload endianness.&quot;&quot;&quot;</span>
<span class="n">MSG_PAYLOAD_ENDIANNESS</span> <span class="o">=</span> <span class="s2">&quot;little&quot;</span> <span class="c1">#: for using int.to_bytes( , MSG_PAYLOAD_ENDIANNESS)</span>
<span class="n">MSG_PAYLOAD_ENDIANNESS_v2</span> <span class="o">=</span> <span class="s2">&quot;&lt;&quot;</span>     <span class="c1">#: for using pack(&quot;&lt;b&quot;, number) for the same purpose</span>
    
<span class="c1">#: Endpoint where data coming from node running the evaluation application are expected.</span>
<span class="n">UPLINK_PACKET_EVAL_APP_ENDPOINT</span> <span class="o">=</span> <span class="mi">1</span>


<span class="c1"># SETTINGS FILE/MODULES</span>
<span class="n">FILE_SETTINGS_LOCAL</span> <span class="o">=</span> <span class="s2">&quot;local_settings.py&quot;</span> <span class="c1">#: file where the local message id is stored</span>
<span class="n">FILE_SETTINGS_GLOBAL</span> <span class="o">=</span> <span class="s2">&quot;cloud_settings.py&quot;</span> <span class="c1">#: file where the global message id is stored</span>


<span class="c1">#: interaction variables (to be deleted in production)</span>
<span class="c1"># sink= &quot;sink0&quot;</span>
<span class="c1"># node_id=&quot;1195333106&quot;</span>
<span class="c1">#: wirepass address for a broadcast to all nodes</span>
<span class="n">broadcast_address</span><span class="o">=</span><span class="s2">&quot;0xFFFFFFFF&quot;</span>         
<span class="c1"># node_id=&quot;1767199611&quot;</span>
<span class="c1"># node_id=&quot;2727&quot;</span>
<span class="c1"># node_id=&quot;31415&quot;</span>
<span class="c1"># gw_id=&quot;193853683731279&quot;</span>

<span class="c1"># mqtt super topics:</span>
<span class="c1">#: cloud requests to a specific node</span>
<span class="n">CLOUD_REQUEST_TO_NODE_MQTT_SUPERTOPIC</span><span class="o">=</span>                          <span class="s2">&quot;cl-req/n/&quot;</span>
<span class="c1">#: cloud requests to a gateway</span>
<span class="n">CLOUD_REQUEST_TO_GATEWAY_MQTT_SUPERTOPIC</span><span class="o">=</span>                       <span class="s2">&quot;cl-req/gw/&quot;</span>
<span class="c1">#: gateway response to a cloud request to a specific node</span>
<span class="n">GATEWAY_RESPONSE_TO_CLOUD_REQUEST_TO_NODE_MQTT_SUPERTOPIC</span> <span class="o">=</span>     <span class="s2">&quot;gw-res/n/&quot;</span>
<span class="c1">#: gateway responds to a cloud request to the gateway</span>
<span class="n">GATEWAY_RESPONSE_TO_CLOUD_REQUEST_TO_GATEWAY_MQTT_SUPERTOPIC</span> <span class="o">=</span>  <span class="s2">&quot;gw-res/gw/&quot;</span>
<span class="c1">#: gateway makes a request to the cloud</span>
<span class="n">GATEWAY_REQUEST_TO_CLOUD_MQTT_SUPERTOPIC</span><span class="o">=</span>                       <span class="s2">&quot;gw-req/gw/&quot;</span>
<span class="c1">#: cloud responds to the previous request the gateway made</span>
<span class="n">CLOUD_RESPONSE_TO_GATEWAY_REQUEST_MQTT_SUPERTOPIC</span><span class="o">=</span>             <span class="s2">&quot;cl-res/gw/&quot;</span>
<span class="c1">#: node requests something to the gateway:</span>
<span class="n">NODE_REQUEST_TO_GATEWAY_MQTT_SUPERTOPIC</span> <span class="o">=</span>                       <span class="s2">&quot;gw-event/received_data/&quot;</span>

<span class="c1">#: list of MQTT topics used by the simulated cloud</span>
<span class="n">FAKE_CLOUD_PUB_SUPERTOPIC_LIST</span> <span class="o">=</span> <span class="p">[</span><span class="n">CLOUD_REQUEST_TO_NODE_MQTT_SUPERTOPIC</span><span class="p">,</span> 
                                  <span class="n">CLOUD_REQUEST_TO_GATEWAY_MQTT_SUPERTOPIC</span><span class="p">,</span> 
                                  <span class="n">CLOUD_RESPONSE_TO_GATEWAY_REQUEST_MQTT_SUPERTOPIC</span><span class="p">]</span>


<span class="c1">#: MQTT supertopic list</span>
<span class="n">SUPERTOPIC_LIST</span> <span class="o">=</span> <span class="p">[</span><span class="n">CLOUD_REQUEST_TO_NODE_MQTT_SUPERTOPIC</span><span class="p">,</span>
                   <span class="n">CLOUD_REQUEST_TO_GATEWAY_MQTT_SUPERTOPIC</span><span class="p">,</span>
                   <span class="n">GATEWAY_RESPONSE_TO_CLOUD_REQUEST_TO_NODE_MQTT_SUPERTOPIC</span><span class="p">,</span>
                   <span class="n">GATEWAY_RESPONSE_TO_CLOUD_REQUEST_TO_GATEWAY_MQTT_SUPERTOPIC</span><span class="p">,</span>
                   <span class="n">GATEWAY_REQUEST_TO_CLOUD_MQTT_SUPERTOPIC</span><span class="p">,</span>
                   <span class="n">CLOUD_RESPONSE_TO_GATEWAY_REQUEST_MQTT_SUPERTOPIC</span><span class="p">,</span>
                   <span class="n">NODE_REQUEST_TO_GATEWAY_MQTT_SUPERTOPIC</span><span class="p">]</span>


<div class="viewcode-block" id="unpack_bytes"><a class="viewcode-back" href="../modules/global_vars.html#global_vars.unpack_bytes">[docs]</a><span class="k">def</span> <span class="nf">unpack_bytes</span><span class="p">(</span><span class="nb">format</span><span class="p">,</span> <span class="n">buffer</span><span class="p">)</span> <span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Converts bytes package to decimal.</span>
<span class="sd">    The format is according to the reference `https://docs.python.org/3/library/struct.html &lt;https://docs.python.org/3/library/struct.html&gt;`__ .</span>
<span class="sd">    Format can be unsigned char (B), signed char (b), unsigned int (I) i signed int (i) usually either *b,B,h,H,i,I,q,Q*</span>
<span class="sd">    </span>
<span class="sd">    :param format: one of the different decompression from bytes options according to the reference </span>
<span class="sd">    :type format: string</span>
<span class="sd">    :param buffer: message payload in bytes that we wish to unpack</span>
<span class="sd">    :type buffer: bytes</span>

<span class="sd">    :return:</span>
<span class="sd">        element (int) -- uncompressed number</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">format</span> <span class="o">==</span> <span class="s2">&quot;&lt;I&quot;</span><span class="p">:</span>      <span class="c1">#: unsigned int, 4 bytes</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;&lt;I&#39;</span><span class="p">,</span> <span class="n">buffer</span><span class="p">))</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
    <span class="k">elif</span> <span class="nb">format</span> <span class="o">==</span> <span class="s2">&quot;&lt;i&quot;</span><span class="p">:</span>    <span class="c1">#: signed int, 4 bytes</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;&lt;i&#39;</span><span class="p">,</span> <span class="n">buffer</span><span class="p">))</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
    <span class="k">elif</span> <span class="nb">format</span> <span class="o">==</span> <span class="s2">&quot;&lt;b&quot;</span><span class="p">:</span>    <span class="c1">#: signed char, 1 byte</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;&lt;b&#39;</span><span class="p">,</span> <span class="n">buffer</span><span class="p">))</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
    <span class="k">elif</span> <span class="nb">format</span> <span class="o">==</span> <span class="s2">&quot;&lt;B&quot;</span><span class="p">:</span>    <span class="c1">#: unsigned char, 1 byte</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;&lt;B&#39;</span><span class="p">,</span> <span class="n">buffer</span><span class="p">))</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
    <span class="k">elif</span> <span class="nb">format</span> <span class="o">==</span> <span class="s2">&quot;&lt;Q&quot;</span><span class="p">:</span>    <span class="c1">#: unsigned char, 8 byte</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;&lt;Q&#39;</span><span class="p">,</span> <span class="n">buffer</span><span class="p">))</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
    <span class="k">elif</span> <span class="nb">format</span> <span class="o">==</span> <span class="s2">&quot;&lt;H&quot;</span><span class="p">:</span>    <span class="c1">#: unsigned char, 2 byte</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;&lt;H&#39;</span><span class="p">,</span> <span class="n">buffer</span><span class="p">))</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;unpack_bytes error: Format is not any of &lt;i, &lt;I, &lt;b, &lt;B, &lt;H&quot;</span><span class="p">)</span></div>

<span class="k">def</span> <span class="nf">_bytes_to_str_hex_format</span><span class="p">(</span><span class="n">bytes_data</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Returns a string of byte expressed in hexadecimal from a bytearray.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{:02X}</span><span class="s2"> &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">bytes_data</span><span class="p">)</span>

<div class="viewcode-block" id="get_timestamp"><a class="viewcode-back" href="../modules/global_vars.html#global_vars.get_timestamp">[docs]</a><span class="k">def</span> <span class="nf">get_timestamp</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;generate a datetime format date and time which contains up to the milliseconds. This will</span>
<span class="sd">    be used throughout my code</span>
<span class="sd">    </span>
<span class="sd">    :return:</span>
<span class="sd">        timestamp (string) -- Current date and time with a format that includes up to the milliseconds</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">timestamp</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S.</span><span class="si">%f</span><span class="s2">&quot;</span><span class="p">)[:</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">timestamp</span></div>

<span class="c1">#: update the external variable (in local_settings.py) message_id, to keep track of it.</span>
<div class="viewcode-block" id="update_msg_id"><a class="viewcode-back" href="../modules/global_vars.html#global_vars.update_msg_id">[docs]</a><span class="k">def</span> <span class="nf">update_msg_id</span><span class="p">(</span><span class="n">file_settings</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Updates the message id. It gets the message id from the &quot;settings&quot; file, updates it, and returns the value. </span>
<span class="sd">    </span>
<span class="sd">    :param file_settings: file where the variable containing the mesage id is stored. This variable is updated every time a message is sent.</span>
<span class="sd">    :type file_settings: string</span>

<span class="sd">    :return:</span>
<span class="sd">        msg_id (string) -- updated mesage id</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_settings</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span>
    <span class="n">line</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
    <span class="n">message_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="n">msg_id</span> <span class="o">=</span> <span class="n">message_id</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">msg_id</span> <span class="o">&gt;</span> <span class="mi">65535</span><span class="p">:</span>  <span class="c1"># we use 2 bytes for storing the message id number</span>
        <span class="n">msg_id</span><span class="o">=</span><span class="mi">1</span>        <span class="c1"># we reserve the message id of 0 for node messages to gateway</span>


    <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_settings</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span>
    <span class="n">text</span><span class="o">=</span><span class="s2">&quot;msg_id=&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">msg_id</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">msg_id</span></div>


<div class="viewcode-block" id="display_and_set_interaction_mode"><a class="viewcode-back" href="../modules/global_vars.html#global_vars.display_and_set_interaction_mode">[docs]</a><span class="k">def</span> <span class="nf">display_and_set_interaction_mode</span><span class="p">(</span><span class="n">mode_list</span><span class="p">)</span> <span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a user input prompt for selecting an interaction mode</span>
<span class="sd">    </span>
<span class="sd">    :param mode_list: List of the different modes to select from</span>
<span class="sd">    :type mode_list: list</span>

<span class="sd">    :return:</span>
<span class="sd">        mode (string) -- interaction mode selected</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
   
    <span class="k">return</span> <span class="n">select_index_from_list</span><span class="p">(</span><span class="n">mode_list</span><span class="p">,</span> <span class="s2">&quot;mode&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="get_supertopic"><a class="viewcode-back" href="../modules/global_vars.html#global_vars.get_supertopic">[docs]</a><span class="k">def</span> <span class="nf">get_supertopic</span><span class="p">(</span> <span class="n">mqtt_topic</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    cut the mqtt topic (if applicable) and return the segmented string:</span>
<span class="sd">    </span>
<span class="sd">    :param mqtt_topic: MQTT topic</span>
<span class="sd">    :type mqtt_topic: list</span>

<span class="sd">    :return:</span>
<span class="sd">        mqtt_supertopic (string) -- MQTT topic without the node or gateway id. It helps identify the origen of the messages</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">prefix</span> <span class="o">=</span> <span class="s2">&quot;&lt;computing mqtt supertopic&gt; &quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">prefix</span> <span class="o">+</span> <span class="s2">&quot;topic: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">mqtt_topic</span><span class="p">))</span>
    <span class="n">mqtt_supertopic</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">mqtt_topic</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mqtt_topic</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="p">:</span>  <span class="c1">#: if it contains the character &quot;/&quot;</span>
            <span class="n">mqtt_topic</span> <span class="o">=</span> <span class="n">mqtt_topic</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">mqtt_supertopic</span> <span class="o">=</span> <span class="s2">&quot;/&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">mqtt_topic</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;/&quot;</span>
    
    <span class="k">return</span> <span class="n">mqtt_supertopic</span></div>


<div class="viewcode-block" id="get_all_files_in_dir"><a class="viewcode-back" href="../modules/global_vars.html#global_vars.get_all_files_in_dir">[docs]</a><span class="k">def</span> <span class="nf">get_all_files_in_dir</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="s2">&quot;.&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    get a list of all files within the current dir and subdirs.</span>

<span class="sd">    :param path: path where to start looking for files</span>
<span class="sd">    :type path: string</span>

<span class="sd">    :return:</span>
<span class="sd">        :llista: a list of file paths</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">folder</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="n">llist</span> <span class="o">=</span> <span class="n">folder</span><span class="o">.</span><span class="n">rglob</span><span class="p">(</span><span class="s2">&quot;*&quot;</span><span class="p">)</span>
    <span class="n">llista</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">llist</span><span class="p">)))</span>
    
    <span class="k">return</span> <span class="n">llista</span></div>

<div class="viewcode-block" id="select_index_from_list"><a class="viewcode-back" href="../modules/global_vars.html#global_vars.select_index_from_list">[docs]</a><span class="k">def</span> <span class="nf">select_index_from_list</span><span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;file&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a user input prompt for selecting an index from a list</span>
<span class="sd">    </span>
<span class="sd">    :param list: List of the different elements to select from</span>
<span class="sd">    :type list: list</span>

<span class="sd">    :return:</span>
<span class="sd">        index (string) -- index of the list selected</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">i</span><span class="o">=</span><span class="mi">1</span>
    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">list</span> <span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;: &quot;</span> <span class="o">+</span> <span class="n">a</span><span class="p">)</span>
        <span class="n">i</span><span class="o">=</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span>
    <span class="n">ind</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;choose one &quot;</span><span class="o">+</span><span class="n">label</span><span class="o">+</span><span class="s2">&quot; from above: &quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;index &#39;&quot;</span> <span class="o">+</span> <span class="n">ind</span> <span class="o">+</span> <span class="s2">&quot;&#39; selected&quot;</span><span class="p">)</span>
    <span class="n">ind</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ind</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span>
    <span class="k">return</span> <span class="n">ind</span></div>


<div class="viewcode-block" id="select_elem_from_list"><a class="viewcode-back" href="../modules/global_vars.html#global_vars.select_elem_from_list">[docs]</a><span class="k">def</span> <span class="nf">select_elem_from_list</span><span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;file&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a user input prompt for selecting an element from a list</span>
<span class="sd">    </span>
<span class="sd">    :param list: List of the different elements to select from</span>
<span class="sd">    :type list: list</span>
<span class="sd">    :param label: Name we want to show to the user, regarding the type of objects displayed inside the list</span>
<span class="sd">    :type label: string</span>

<span class="sd">    :return:</span>
<span class="sd">        element (string) -- element selected</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ind</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">select_index_from_list</span><span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="n">label</span><span class="p">))</span>
    <span class="n">elem</span> <span class="o">=</span> <span class="nb">list</span><span class="p">[</span><span class="n">ind</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">label</span> <span class="o">+</span> <span class="s2">&quot; &#39;&quot;</span> <span class="o">+</span> <span class="n">elem</span> <span class="o">+</span> <span class="s2">&quot;&#39; selected&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">elem</span></div>

<span class="c1"># callback functions on publish/subscribe: </span>
<div class="viewcode-block" id="get_sink_and_gw"><a class="viewcode-back" href="../modules/global_vars.html#global_vars.get_sink_and_gw">[docs]</a><span class="k">def</span> <span class="nf">get_sink_and_gw</span><span class="p">(</span> <span class="n">wni</span> <span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Find the gateway id and sink id. Store them in the mqtt_interaction class in order to use them later on.</span>
<span class="sd">    We find the gateway and sink ids, in the following steps:</span>
<span class="sd">        </span>
<span class="sd">        1. We try first to exploit the construction of the WNI class, to quickly get the needed information, without using the wirepas</span>
<span class="sd">        recommended functions. This is, we directly call the *wni._gateways.values()* function to get all the available gateways.</span>
<span class="sd">        2. In case this returns an empty list, it is likely that the reason is that not enough time ellapsed between the creations</span>
<span class="sd">        of the WNI interface, and the call to get its gateways. If that is the case, then wait 300ms, and try again. Wirepas guys say </span>
<span class="sd">        this can be because the WNI is destroyed before the connexion with the local MQTT broker is made.</span>
<span class="sd">        3. If this approach fails, use the classic wirepas *get_sinks()* function in order to get the gateway and </span>
<span class="sd">        sink ids.</span>
<span class="sd">        4. Once one of the methods above worked, the job is done.</span>

<span class="sd">    :param wni: Wirepas network interface object</span>
<span class="sd">    :type wni: wirepas_mqtt_library.WirepasNetworkInterface</span>

<span class="sd">    :return: a list containing:</span>
<span class="sd">        sink (string) -- sink id of the gateway</span>
<span class="sd">        gateway_id (int) -- gateway id</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">prefix</span> <span class="o">=</span> <span class="s2">&quot;&lt;get sink&amp;gw from wni&gt; &quot;</span>
    <span class="c1"># node interaction class mqtt broker credentials</span>
    <span class="c1"># Create &quot;Wirepas Network Interface&quot; and enable its logger</span>
    <span class="c1"># declare the wirepass network interface global variable</span>
    <span class="n">gw_id</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">sink</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">try</span><span class="p">:</span>
        
        <span class="n">gws</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">wni</span><span class="o">.</span><span class="n">_gateways</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="c1"># if we get no gateways after calling the WNI, it means we run this command before the WNI was properly formed.</span>
        <span class="c1"># we should wait a few seconds and try again:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">gws</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> we waited 300ms extra, to get the list of gateways!&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">prefix</span><span class="p">))</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.3</span><span class="p">)</span>
            <span class="n">gws</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">wni</span><span class="o">.</span><span class="n">_gateways</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="n">gw</span> <span class="o">=</span> <span class="n">gws</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">gw_id</span> <span class="o">=</span> <span class="n">gw</span><span class="o">.</span><span class="n">id</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> gw id: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">gw_id</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">gw</span><span class="o">.</span><span class="n">sinks</span> <span class="o">!=</span> <span class="p">[]:</span>
            <span class="n">sink</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">gw</span><span class="o">.</span><span class="n">sinks</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> sink: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">sink</span><span class="p">))</span>
            <span class="n">sink</span> <span class="o">=</span> <span class="n">sink</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;sink_id&quot;</span><span class="p">]</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> Got the following gateway id: </span><span class="si">{}</span><span class="s2"> and for the first gateway, got the following sink: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">prefix</span><span class="p">,</span> <span class="n">gw_id</span><span class="p">,</span> <span class="n">sink</span><span class="p">))</span>
        <span class="k">else</span> <span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> sink list of gateway </span><span class="si">{}</span><span class="s2"> is empty, defaulting to normal wni.get_sinks() extraction...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">gw_id</span><span class="p">))</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> sink list of gateway </span><span class="si">{}</span><span class="s2"> is empty, defaulting to normal wni.get_sinks() extraction...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">gw_id</span><span class="p">))</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> Failed when extracting gateway values from WNI using an observed wirepas code shortcut&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">prefix</span><span class="p">))</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">sink_list</span> <span class="o">=</span> <span class="n">wni</span><span class="o">.</span><span class="n">get_sinks</span><span class="p">()</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">gw_id</span> <span class="o">=</span> <span class="n">sink_list</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">sink</span> <span class="o">=</span> <span class="n">sink_list</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> Failed when extracting gateway values from WNI using the wirepas suggested functions&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">prefix</span><span class="p">))</span>

    <span class="nb">print</span><span class="p">(</span><span class="n">prefix</span> <span class="o">+</span> <span class="s2">&quot;gw_id: &#39;&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">gw_id</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;&#39;&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">prefix</span> <span class="o">+</span> <span class="s2">&quot;sink_id: &#39;&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">sink</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;&#39;&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">gw_id</span> <span class="o">==</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">sink</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> ERROR: no gateway id detected&quot;</span><span class="p">)</span>
    <span class="k">return</span><span class="p">([</span><span class="n">sink</span><span class="p">,</span> <span class="n">gw_id</span><span class="p">])</span></div>


<div class="viewcode-block" id="create_wni"><a class="viewcode-back" href="../modules/global_vars.html#global_vars.create_wni">[docs]</a><span class="k">def</span> <span class="nf">create_wni</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create wirepass network interface. This function gets the local credentials stored in the mqtt credentials py file, and returns a wni that can be used</span>
<span class="sd">    to establish a connection between the gateway backend and the sink.</span>

<span class="sd">    It works in the following way:</span>

<span class="sd">        1. It creates a wirepas network interface</span>
<span class="sd">        2. It waits at least 0.2 seconds for the wirepas network interface to be properly created</span>


<span class="sd">    :param local_broker: IP address of the local broker we want to connect to</span>
<span class="sd">    :type local_broker: IP address</span>
<span class="sd">    :param local_port: port of the local broker that accepts the MQTT connection</span>
<span class="sd">    :type local_port: int</span>
<span class="sd">    :param local_user: user (if authentication is ON)</span>
<span class="sd">    :type local_user: string</span>
<span class="sd">    :type local_password: password (if authentication is ON)</span>
<span class="sd">    :type local_password: string</span>
<span class="sd">    :param insecure: if you want to use a secure or insecure connection, and use session keys</span>
<span class="sd">    :type insecure: bool</span>

<span class="sd">    :returns:</span>
<span class="sd">        wni (*wirepas_mqtt_library.WirepasNetworkInterface*) object -- </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">prefix</span> <span class="o">=</span> <span class="s2">&quot;&lt;creating WNI&gt;&quot;</span>
    <span class="p">[</span><span class="n">local_user</span><span class="p">,</span> <span class="n">local_password</span><span class="p">,</span> <span class="n">global_insecure</span><span class="p">]</span> <span class="o">=</span> <span class="n">creds</span><span class="o">.</span><span class="n">get_local_creds</span><span class="p">()</span>
    <span class="n">wni</span> <span class="o">=</span> <span class="n">WirepasNetworkInterface</span><span class="p">(</span>
                                  <span class="n">creds</span><span class="o">.</span><span class="n">local_broker</span><span class="p">,</span>
                                  <span class="n">creds</span><span class="o">.</span><span class="n">local_port</span><span class="p">,</span>
                                  <span class="n">local_user</span><span class="p">,</span>
                                  <span class="n">local_password</span><span class="p">,</span>
                                  <span class="n">insecure</span><span class="o">=</span><span class="n">creds</span><span class="o">.</span><span class="n">local_insecure</span>
                                  <span class="p">)</span> <span class="c1">#insecure=FALSE implies that a secure connection </span>
                                  <span class="c1"># between client-broker is established using session keys</span>
    <span class="c1"># time.sleep(0.2)   # we wait 0.1 seconds to ensure all the wni setup is set properly, before starting to use it.</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> wni created (in theory)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">prefix</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">wni</span></div>

<div class="viewcode-block" id="create_otaphelper"><a class="viewcode-back" href="../modules/global_vars.html#global_vars.create_otaphelper">[docs]</a><span class="k">def</span> <span class="nf">create_otaphelper</span><span class="p">(</span><span class="n">wni</span><span class="p">,</span> <span class="n">network</span> <span class="o">=</span> <span class="n">NETWORK_DEFAULT_CHANNEL</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    brief function that converts a WNI interface to an OtapHelper object, after selecting a network channel</span>
<span class="sd">    </span>
<span class="sd">    :param wni: Wirepas network interface that allows the connection from the gateway backend to the sink, via the local MQTT broker</span>
<span class="sd">    :type wni: wirepas_mqtt_library.WirepasNetworkInterface</span>
<span class="sd">    :param network: Network channel to which we want to create the Otap to.</span>
<span class="sd">    :type network: int</span>

<span class="sd">    :returns:</span>
<span class="sd">        otapHelper (*wirepas_mqtt_library.WirepasOtapHelper*) object -- </span>
<span class="sd">        </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">otapHelper</span> <span class="o">=</span> <span class="n">WirepasOtapHelper</span><span class="p">(</span><span class="n">wni</span><span class="p">,</span>
                                   <span class="nb">int</span><span class="p">(</span><span class="n">network</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">otapHelper</span></div>



</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, Romà Masana.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>